# Архитектура BitcoinFinder Web Server

## Обзор системы

BitcoinFinder Web Server - это веб-приложение для поиска Bitcoin seed phrases с поддержкой фонового выполнения задач.

## Компоненты системы

### 1. Веб-интерфейс (Frontend)
- **Страницы:**
  - `/Home/Index` - Главная страница
  - `/Home/SeedSearch` - Создание и мониторинг поиска
  - `/Home/TaskManager` - Управление задачами
  - `/Home/Admin` - Администрирование

### 2. API (Backend)
- **TaskController** (`/api/task/*`) - Управление задачами
- **AccountController** (`/login`) - Авторизация
- **HomeController** - Веб-страницы

### 3. Сервисы (Services)
- **TaskManager** - Управление задачами и их состоянием
- **BackgroundTaskService** - Фоновое выполнение задач
- **SeedPhraseFinder** - Поиск seed phrases
- **TaskStorageService** - Сохранение/загрузка задач
- **AuthService** - Авторизация пользователей

## Жизненный цикл задачи

### 1. Создание задачи
```
Пользователь → SeedSearch.cshtml → /api/task/create → TaskManager.CreateTaskAsync()
```

**Что происходит:**
- Создается объект `SearchTask` с параметрами
- Задача сохраняется в `tasks_config.json`
- Возвращается ID задачи

### 2. Запуск задачи
```
/api/task/task/{id}/start → BackgroundTaskService.StartTaskAsync()
```

**Что происходит:**
- Задача добавляется в `_runningTasks` (ConcurrentDictionary)
- Создается CancellationTokenSource для управления
- Запускается фоновый поток `RunTaskWorkerAsync()`
- Статус задачи меняется на "Running"

### 3. Выполнение задачи
```
BackgroundTaskService → SeedPhraseFinder → Обработка блоков
```

**Что происходит:**
- Задача разбивается на блоки (SearchBlock)
- Каждый блок обрабатывается в отдельном потоке
- Прогресс сохраняется в `temp_progress_{blockId}.json`
- Найденные фразы добавляются в очередь логов

### 4. Мониторинг
```
Веб-интерфейс → /api/task/live-log → SeedPhraseFinder.GetLastSeedPhrases()
```

**Что происходит:**
- API возвращает последние обработанные фразы
- Прогресс загружается из файлов
- Статистика обновляется в реальном времени

## Файловая структура

### Конфигурационные файлы
- `tasks_config.json` - Список всех задач
- `server_state.json` - Состояние сервера
- `agent_states.json` - Состояние агентов

### Файлы прогресса
- `temp_progress_{blockId}.json` - Прогресс каждого блока
- `standalone_progress.json` - Общий прогресс

### Логи
- `logs/` - Логи приложения
- In-memory очередь фраз для live-log

## Фоновое выполнение

### BackgroundTaskService
- **IHostedService** - Запускается при старте приложения
- **Восстановление задач** - При перезапуске восстанавливает "Running" задачи
- **Мониторинг** - Проверяет состояние задач каждые 5 секунд

### Сохранение состояния
- **Автосохранение** - Каждые 1000 обработанных комбинаций
- **Блоки** - Каждый блок сохраняется отдельно
- **Восстановление** - При перезапуске продолжает с последней точки

## API Endpoints

### Управление задачами
- `POST /api/task/create` - Создание задачи
- `GET /api/task/list` - Список задач
- `GET /api/task/{id}` - Детали задачи
- `POST /api/task/task/{id}/start` - Запуск задачи
- `POST /api/task/task/{id}/pause` - Пауза задачи
- `POST /api/task/task/{id}/stop` - Остановка задачи
- `DELETE /api/task/task/{id}` - Удаление задачи

### Мониторинг
- `GET /api/task/live-log` - Живой лог фраз
- `GET /api/task/progress/current` - Текущий прогресс
- `GET /api/task/status` - Статус системы

### Управление сервером
- `POST /api/task/start` - Запуск сервера
- `POST /api/task/stop` - Остановка сервера
- `POST /api/task/set-threads` - Установка количества потоков

## Безопасность

### Авторизация
- Сессии для веб-интерфейса
- API ключи для агентов
- `[AllowAnonymous]` для API мониторинга

### Валидация
- Проверка входных параметров
- Ограничения на количество потоков
- Валидация Bitcoin адресов

## Производительность

### Многопоточность
- Каждая задача выполняется в отдельном потоке
- Настраиваемое количество потоков
- ConcurrentDictionary для управления задачами

### Оптимизация
- Блочная обработка для экономии памяти
- Автосохранение прогресса
- In-memory кэш для live-log

## Мониторинг и отладка

### Логирование
- Структурированные логи с уровнями
- Логирование всех операций с задачами
- Отслеживание производительности

### Метрики
- Количество обработанных комбинаций
- Скорость обработки (фраз/сек)
- Время выполнения задач
- Использование памяти

## Восстановление после сбоев

### Автоматическое восстановление
- При перезапуске сервера задачи восстанавливаются
- Прогресс загружается из файлов
- Незавершенные блоки продолжают обработку

### Ручное восстановление
- Возможность принудительной остановки задач
- Очистка поврежденных файлов состояния
- Сброс прогресса для конкретных задач 